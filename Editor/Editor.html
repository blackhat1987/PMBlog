<!DOCTYPE html>
<html>
	<head>
		<title>撰写文档</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<link rel="stylesheet" type="text/css" href="<?php echo PLUGINS_DIR; ?>/Editor/res/style.css" />
		<link rel="stylesheet" tyle="text/css" href="<?php echo PLUGINS_DIR; ?>/Editor/res/code.css" />		
		<script type="text/javascript" src="<?php echo PLUGINS_DIR; ?>/Editor/res/Markdown.Converter.js"></script>
		<script type="text/javascript" src="<?php echo PLUGINS_DIR; ?>/Editor/res/Markdown.Sanitizer.js"></script>
		<script type="text/javascript" src="<?php echo PLUGINS_DIR; ?>/Editor/res/Markdown.Editor.js"></script>
		<script type="text/javascript" src="<?php echo PLUGINS_DIR; ?>/Editor/res/prettify.js"></script>
	</head>
	<body>
		<div id="main">			
			<form id="form" name="form" method="POST" action="index.php">
				<div id="mainGroup">
					<h1>撰写文档</h1>
					<p><input type="text" id="title" name="title" value="" required /></p>
					<p>
						<label for="name" title="保存文件名不建议使用中文">文件名不建议使用中文:
						<input type="text" title="保存文件名不建议使用中文" id="docpath" name="docpath" pattern="[^\<\>\*\?]+" value="<?php echo $docpath; ?>" required <?php echo $newfile?'':'readonly'; ?> />（不得使用部分半角符号如?<>*）</label>
					</p>
					<div id="wmd-button-bar"></div>
					<p><textarea class="wmd-input" id="wmd-input" name="content"></textarea></p>
					<div>
						<span id="autosave"></span>
						<span id="saveButton">
							<label for="draft" >草稿</label>
							<input type="checkbox" id="draft" name="draft" value="draft" />
							<input type="button" id="cancel" name="cancel" value="回档" />
							<input type="submit" id="submitPublish" name="submitPublish" value="保存" />
							<input type="hidden" id="newfile" name="newfile" value="<?php echo $newfile?'true':'false'; ?>" />
						</span>
					</div>
				</div>
				<div id="previewGroup">
					<div id="wmd-preview" class="wmd-preview"></div>
				</div>
				<div id="metaGroup">
					<section class="option post page">
						<label>类型</label>
						<p class="border">
							<label for="type_post">文章</label>
							<input type="radio" value="post" id="type_post" name="type" />
							<label for="type_page">页面</label>
							<input type="radio" value="page" id="type_page" name="type" />
						</p>
					</section>
					<section class="option post page">
						<label for="date">发布日期</label>
						<p><input type="text" value="" id="date" name="date" /></p>
					</section>
					<section class="option post">
						<label for="categories">分类（请使用英文逗号,分隔）</label>
						<p><input type="text" value="" id="categories" name="categories" /></p>
					</section>
					<section class="option post">
						<label for="tags">标签（请使用英文逗号,分隔）</label>
						<p><input type="text" value="" id="tags" name="tags" /></p>
					</section>
					<section class="option page post">
						<label for="template">模板</label>
						<p><input type="text" value="" id="template" name="template" /></p>
					</section>
				</div>
				<textarea id="editortext" name="editortext"><?php echo $content; ?></textarea>
			</form>
		</div>
<script type="text/javascript">	
var isNew = !byId('docpath').readOnly,
source = byId('editortext').value,
lsKey = 'text' + (isNew ? '' : ('_' + byId('docpath').value));
if(localStorage[lsKey]) byId('editortext').value = localStorage[lsKey];
splitText();
bindEditMode();
bindMarkdown();
addListener(byId('form'),'submit',checkName);
addListener(byId('cancel'),'click',goBack);
addListener(byId('docpath'),'keydown',inputNameSize);
each(byName('type'),function (item) {
	addListener(item,'click',bindTypeClick)
});




//sweet suger...
function query(name) {
	return document.querySelector(name);
}
function queryAll(name) {
	return document.querySelectorAll(name);
}
function byId(name) {
	return document.getElementById(name);
}
function byName(name) {
	return document.getElementsByName(name);
}
function byTag(name) {
	return document.getElementsByTagName(name);
}
function addListener(element,e,fn){
	if(element.addEventListener){
		element.addEventListener(e,fn,false)
	} else {
		element.attachEvent("on" + e,fn)
	}
}
function each(obj, iterator, context) {
	var nativeForEach = Array.prototype.forEach;
	var breaker = {}
	if (obj == null) return;
	if (nativeForEach && obj.forEach === nativeForEach) {
		obj.forEach(iterator, context);
	} else if (obj.length === +obj.length) {
		for (var i = 0, length = obj.length; i < length; i++) {
			if (iterator.call(context, obj[i], i, obj) === breaker) return;
		}
	} else {
		var keys = _.keys(obj);
		for (var i = 0, length = keys.length; i < length; i++) {
			if (iterator.call(context, obj[keys[i]], keys[i], obj) === breaker) return;
		}
	}
}
function trim(str) {
	return str.replace(/(^[\s\t\n]*)|([\s\t\n]*$)/g,'');;
}
//回到初始数据
function goBack() {
	if(confirm('确认放弃本次修改并回档？')){
		localStorage[lsKey] = '';
		byId('editortext').value = source;
		splitText();
	}
}
//输入框长度
function inputNameSize() {
	var $name = byId('docpath')
		$div = document.createElement('div');
	;
	
	$name.style.width = ($name.value.length + 3 )/2*1.06 + 'em';
}

//自动保存
function autoSave() {
	joinText();
	localStorage[lsKey] = byId('editortext').value;
	var as = byId('autosave');
	as.innerHTML = (isNew ? "新" : "当前") + (byId('type_post').checked ? '文章' : '页面') + "已自动保存";
	as.style.display = 'block';
	setTimeout(function() {
		as.style.display = 'none';
	}, 1500);
	return true;
}

//编辑/新建模式
function bindEditMode() {
	byTag('h1')[0].innerHTML = (isNew ? "新建" : "编辑") + (byId('type_post').checked ? '文章' : '页面');
}

//代码高亮
function prettify() {
	var pre = byTag('pre');
	for(i=0,l=pre.length;i<l;i++) {
		if(pre[i].className.indexOf('prettyprint') == -1) 
		pre[i].className += ' prettyprint'
	}
	prettyPrint()
}

//markdown功能
function bindMarkdown() {
	var converter = Markdown.getSanitizingConverter();
	converter.hooks.chain("preBlockGamut", function (text, rbg) {
		return text.replace(/^ {0,3}""" *\n((?:.*?\n)+?) {0,3}""" *$/gm, function (whole, inner) {
			return "<blockquote>" + rbg(inner) + "</blockquote>\n"
		})
	});
	var editor = new Markdown.Editor(converter);
	editor.run()
}

//提交前验证
function checkName() {
	var $name = byId('docpath'),name = $name.value;
	if(!name || /[\<\>\*\?]/gi.test(name)){
		alert('文件名留空或者使用了非法字符，请重新填写！');
		$name.focus();
		return false
	}
	joinText();
	return true
}

//绑定类型
function bindTypeClick(first_argument) {
	var isPost = byId('type_post').checked,
	value = isPost ? 'post' : 'page';
	bindEditMode();
	each(queryAll('section'),function (item) {
		if(item.className.indexOf(value) > 0){
			item.style.display = 'block';
		}else{
			item.style.display = 'none';
		}
	});
}

//分解文章内容
function splitText() {
	var article = byId('editortext').value;
	function r(re) {
		var t = re.exec(article);
		return t?t[1]:'';
	}
	var retval = {};
	//retval.text = article.replace(/[\n]*(title|status|tags|date|type|template|category|custom-.*):[^\n]*\n+/ig, '');
	retval.text = trim(article.replace(/[\n]*(title|status|tags|date|type|template|category):[^\n]*\n*/ig, '').replace(/[\n]+#([^#\n]*)\s*/ig, ''));
	retval.title = trim(r(/^title\:(.*)\s*/im));
	if(!retval.title){
		retval.title = trim(r(/^#([^#\n]*)\s*/im));
	}
	retval.date = trim(r(/^date\:(.*)\s*/im));
	retval.status = trim(r(/^status\:(.*)\s*/im)) !== 'draft';
	retval.categories = trim(r(/^category\:(.*)\s*/im));
	retval.tags = trim(r(/^tags\:(.*)\s*/im));
	retval.type = trim(r(/^type\:(.*)\s*/im));
	if(retval.type !== 'page'){retval.type = 'post'}
	retval.template = r(/^template\:(.*)\s*/im);
	/*
	retval.custom = {};
	var custom, custom_re = /^custom-(.*?):(.*?)$/igm;
	while((custom = custom_re.exec(article)) != null){
		retval.custom[custom[1]] = custom[2]
	}
	*/
	byId('wmd-input').value = retval.text;
	byId('title').value = retval.title;
	byId('date').value = retval.date;
	
	byId('draft').checked = !retval.status;
	byId('categories').value = retval.categories;
	byId('tags').value = retval.tags;
	byId('template').value = retval.template;
	var $type = byName('type');
	each($type,function (value) {
		value.checked = value.value == retval.type;
	});
	bindTypeClick();
	inputNameSize();
	this.a=retval;
	//return retval
}
//合并文章内容
function joinText() {
	var retval = ['title:' + byId('title').value], t;
	if(byId('type_page').checked)retval.push('type:page');
	if(t=trim(byId('date').value))retval.push('date:' + t);
	if(t=trim(byId('categories').value))retval.push('category:' +t);
	if(t=trim(byId('tags').value))retval.push('tags:' + t);
	if(t=trim(byId('template').value))retval.push('template:' + t);
	if(byId('draft').checked)retval.push('status:draft');
	retval.push(trim(byId('wmd-input').value));
	byId('editortext').value =( retval.join('\n'));
	//return retval
}


setInterval("prettify()", 10);
setInterval("autoSave()", 15000);

</script>
	</body>
</html>
