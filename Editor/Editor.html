<!DOCTYPE html>

<html>

    <head>
        <title>撰写文章</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="<?php echo PLUGINS_DIR; ?>/Editor/res/style.css" />
        <link rel="stylesheet" tyle="text/css" href="<?php echo PLUGINS_DIR; ?>/Editor/res/code.css" />
        
        <script type="text/javascript" src="<?php echo PLUGINS_DIR; ?>/Editor/res/Markdown.Converter.js"></script>
        <script type="text/javascript" src="<?php echo PLUGINS_DIR; ?>/Editor/res/Markdown.Sanitizer.js"></script>
        <script type="text/javascript" src="<?php echo PLUGINS_DIR; ?>/Editor/res/Markdown.Editor.js"></script>
        <script type="text/javascript" src="<?php echo PLUGINS_DIR; ?>/Editor/res/prettify.js"></script>
    </head>
    
    <body>
        <div class="wmd-panel">
	        <form name="form" method="POST" action="index.php">
		        <label for="name">保存文件名称：<input type="text" id="name" name="name" value="<?php echo $name; ?>" required <?php echo $newfile?'':'readonly'; ?>></label>（不推荐使用中文名称）
			    <input type="hidden" id="newfile" name="newfile" value="<?php echo $newfile?'true':'false'; ?>" />
	            <div id="wmd-button-bar"></div>
	            <textarea class="wmd-input" id="wmd-input" name="editortext"><?php echo $content; ?></textarea>
	            
            </form>
        </div>
        <div id="wmd-preview" class="wmd-panel wmd-preview"></div>
        <div id="autosave"></div>
        <button type="submit" class="primary" id="btn-submit" onclick="prom()"><?php echo $newfile?'发布':'更新'; ?></button>

        <script type="text/javascript">
	        var isNew = !document.getElementById('name').readOnly,	        
	        lsKey = 'text' + (isNew ? '' : ('_' + document.getElementById('name').value));
			function prom() {
			    var name = document.getElementById('name').value;
			    if(!name || /[\/\\\<\>\*\?]/gi.test(name)){
				    alert('文件名留空或者使用了非法字符，请重新填写！');
				    document.getElementById('name').focus();
				    return false
				}
			    form.submit();
			}
            function prettify() {
                var pre = document.getElementsByTagName('pre');
                for(i=0,l=pre.length;i<l;i++) {
                    if(pre[i].className.indexOf('prettyprint') == -1) 
                        pre[i].className += ' prettyprint';
                }
                prettyPrint();
            }
            function autosave() {
	            var text = document.getElementById('wmd-input');
	            localStorage[lsKey] = text.value;
	            var as = document.getElementById('autosave');
	            as.innerHTML = isNew ? "新文章已自动保存" : "“" + document.getElementById('name').value + "”已自动保存";
	            as.style.display = 'block';
	            setTimeout(function() {
					as.style.display = 'none';
		        }, 1500);
            }
            (function () {
                var converter = Markdown.getSanitizingConverter();
                
                converter.hooks.chain("preBlockGamut", function (text, rbg) {
                    return text.replace(/^ {0,3}""" *\n((?:.*?\n)+?) {0,3}""" *$/gm, function (whole, inner) {
                        return "<blockquote>" + rbg(inner) + "</blockquote>\n";
                    });
                });
                
                var editor = new Markdown.Editor(converter);
                
                editor.run();
				if(localStorage[lsKey]) document.getElementById('wmd-input').value = localStorage[lsKey];
                setInterval("prettify()", 10);
				setInterval("autosave()", 15000);

            })();
        </script>
    </body>
</html>
